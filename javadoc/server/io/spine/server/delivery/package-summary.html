<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc (1.8.0_151) on Tue Sep 25 16:22:48 UTC 2018 -->
<title>io.spine.server.delivery (server 0.10.91-SNAPSHOT API)</title>
<meta name="date" content="2018-09-25">
<link rel="stylesheet" type="text/css" href="../../../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../../../script.js"></script>
</head>
<body>
<script type="text/javascript"><!--
    try {
        if (location.href.indexOf('is-external=true') == -1) {
            parent.document.title="io.spine.server.delivery (server 0.10.91-SNAPSHOT API)";
        }
    }
    catch(err) {
    }
//-->
</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="topNav"><a name="navbar.top">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.top" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.top.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../overview-summary.html">Overview</a></li>
<li class="navBarCell1Rev">Package</li>
<li>Class</li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../index-all.html">Index</a></li>
<li><a href="../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../io/spine/server/commandbus/package-summary.html">Prev&nbsp;Package</a></li>
<li><a href="../../../../io/spine/server/entity/package-summary.html">Next&nbsp;Package</a></li>
</ul>
<ul class="navList">
<li><a href="../../../../index.html?io/spine/server/delivery/package-summary.html" target="_top">Frames</a></li>
<li><a href="package-summary.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_top">
<li><a href="../../../../allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_top");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<a name="skip.navbar.top">
<!--   -->
</a></div>
<!-- ========= END OF TOP NAVBAR ========= -->
<div class="header">
<p>@CheckReturnValue
 @ParametersAreNonnullByDefault
</p>
<h1 title="Package" class="title">Package&nbsp;io.spine.server.delivery</h1>
<div class="docSummary">
<div class="block">This package is devoted to message delivery and sharding.</div>
</div>
<p>See:&nbsp;<a href="#package.description">Description</a></p>
</div>
<div class="contentContainer">
<ul class="blockList">
<li class="blockList">
<table class="typeSummary" border="0" cellpadding="3" cellspacing="0" summary="Interface Summary table, listing interfaces, and an explanation">
<caption><span>Interface Summary</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Interface</th>
<th class="colLast" scope="col">Description</th>
</tr>
<tbody>
<tr class="altColor">
<td class="colFirst"><a href="../../../../io/spine/server/delivery/Shardable.html" title="interface in io.spine.server.delivery">Shardable</a></td>
<td class="colLast">
<div class="block">A contract for all message destinations, which require the messages sent to them
 to be grouped and processed in shards.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../io/spine/server/delivery/ShardedStreamConsumer.html" title="interface in io.spine.server.delivery">ShardedStreamConsumer</a>&lt;I,E extends io.spine.core.MessageEnvelope&lt;?,?,?&gt;&gt;</td>
<td class="colLast">
<div class="block">The consumer of the sharded messages of a certain type.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../io/spine/server/delivery/Sharding.html" title="interface in io.spine.server.delivery">Sharding</a></td>
<td class="colLast">
<div class="block">The service responsible for orchestrating the shardables and their inbound streams of messages.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../io/spine/server/delivery/ShardingStrategy.html" title="interface in io.spine.server.delivery">ShardingStrategy</a></td>
<td class="colLast">
<div class="block">The strategy of splitting the message targets into shards.</div>
</td>
</tr>
</tbody>
</table>
</li>
<li class="blockList">
<table class="typeSummary" border="0" cellpadding="3" cellspacing="0" summary="Class Summary table, listing classes, and an explanation">
<caption><span>Class Summary</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Class</th>
<th class="colLast" scope="col">Description</th>
</tr>
<tbody>
<tr class="altColor">
<td class="colFirst"><a href="../../../../io/spine/server/delivery/CommandShardedStream.html" title="class in io.spine.server.delivery">CommandShardedStream</a>&lt;I&gt;</td>
<td class="colLast">
<div class="block">The stream of commands sent to a specific shard.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../io/spine/server/delivery/CommandShardedStream.Builder.html" title="class in io.spine.server.delivery">CommandShardedStream.Builder</a>&lt;I&gt;</td>
<td class="colLast">
<div class="block">The builder for the <code>CommandShardedStream</code> instances.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../io/spine/server/delivery/Consumer.html" title="class in io.spine.server.delivery">Consumer</a>&lt;I,E extends <a href="../../../../io/spine/server/entity/Entity.html" title="interface in io.spine.server.entity">Entity</a>&lt;I,?&gt;,M extends io.spine.core.ActorMessageEnvelope&lt;?,?,?&gt;,S extends <a href="../../../../io/spine/server/delivery/ShardedStream.html" title="class in io.spine.server.delivery">ShardedStream</a>&lt;I,?,M&gt;,B extends <a href="../../../../io/spine/server/delivery/ShardedStream.AbstractBuilder.html" title="class in io.spine.server.delivery">ShardedStream.AbstractBuilder</a>&lt;I,M,B,S&gt;&gt;</td>
<td class="colLast">
<div class="block">The consuming part of the <a href="../../../../io/spine/server/delivery/Delivery.html" title="class in io.spine.server.delivery">Delivery</a>.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../io/spine/server/delivery/DeliveryTag.html" title="class in io.spine.server.delivery">DeliveryTag</a></td>
<td class="colLast">
<div class="block">A value, that defines the message destination in the <a href="../../../../io/spine/server/delivery/Delivery.html" title="class in io.spine.server.delivery">delivery process</a>.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../io/spine/server/delivery/EventShardedStream.html" title="class in io.spine.server.delivery">EventShardedStream</a>&lt;I&gt;</td>
<td class="colLast">
<div class="block">The stream of events sent to a specific shard.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../io/spine/server/delivery/EventShardedStream.Builder.html" title="class in io.spine.server.delivery">EventShardedStream.Builder</a>&lt;I&gt;</td>
<td class="colLast">
<div class="block">The builder for the <code>EventShardedStream</code> instances.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../io/spine/server/delivery/InProcessSharding.html" title="class in io.spine.server.delivery">InProcessSharding</a></td>
<td class="colLast">
<div class="block">An implementation of the sharding service, that manages all the data in-memory and runs only
 within the current JVM process.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../io/spine/server/delivery/Sender.html" title="class in io.spine.server.delivery">Sender</a>&lt;I,M extends io.spine.core.ActorMessageEnvelope&lt;?,?,?&gt;&gt;</td>
<td class="colLast">
<div class="block">The sending part of the <a href="../../../../io/spine/server/delivery/Delivery.html" title="class in io.spine.server.delivery">Delivery</a>.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../io/spine/server/delivery/ShardedStream.html" title="class in io.spine.server.delivery">ShardedStream</a>&lt;I,M extends com.google.protobuf.Message,E extends io.spine.core.MessageEnvelope&lt;?,M,?&gt;&gt;</td>
<td class="colLast">
<div class="block">The stream of messages of a particular type sent for the processing to a specific shard.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../io/spine/server/delivery/ShardedStream.AbstractBuilder.html" title="class in io.spine.server.delivery">ShardedStream.AbstractBuilder</a>&lt;I,E extends io.spine.core.MessageEnvelope&lt;?,?,?&gt;,B extends <a href="../../../../io/spine/server/delivery/ShardedStream.AbstractBuilder.html" title="class in io.spine.server.delivery">ShardedStream.AbstractBuilder</a>&lt;I,?,B,S&gt;,S extends <a href="../../../../io/spine/server/delivery/ShardedStream.html" title="class in io.spine.server.delivery">ShardedStream</a>&lt;I,?,?&gt;&gt;</td>
<td class="colLast">
<div class="block">An abstract base for builders of the <code>ShardedStream</code> descendants.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../io/spine/server/delivery/ShardingKey.html" title="class in io.spine.server.delivery">ShardingKey</a></td>
<td class="colLast">
<div class="block">A key which defines the group of <code>Entity</code> instances, which must be processed within
 a single shard.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../io/spine/server/delivery/UniformAcrossTargets.html" title="class in io.spine.server.delivery">UniformAcrossTargets</a></td>
<td class="colLast">
<div class="block">The strategy of splitting the entities into a number of shards uniformly.</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<a name="package.description">
<!--   -->
</a>
<h2 title="Package io.spine.server.delivery Description">Package io.spine.server.delivery Description</h2>
<div class="block">This package is devoted to message delivery and sharding.

 <h2>Preface</h2>

 <p>Very often Spine-based applications are designed for Google Cloud deployment. In particular,
 an AppEngine automatic scaling feature is heavily utilized in order to achieve the best
 performance/cost ratio.

 <p>While such an approach requires zero maintenance of the computational nodes, some special
 attention must be paid to the concurrent access to the data. The thing is that AppEngine
 by default performs round-robin routing of the requests sent to nodes. So that write-side nodes
 may be updating the same <code>Aggregate</code> instances at the same moment.

 <p>Similar issues occur when studying the event delivery from the write-side to read-side.
 The same instances of <code>Projection</code>s must be updated in a synchronous and exclusive fashion.
 Otherwise their state is going to be broken.


 <h2>Sharding</h2>

 <p><code>Aggregate</code>s, <code>ProcessManager</code>s and <code>Projection</code>s are grouped into shards.

 <p>A shard is virtual group of entities of the same entity class (e.g. a group of
 certain <code>Projection</code> instances). In scope of a shard all the entities should
 be processed synchronously, in a single thread per shard.

 <p>So if an <code>Aggregate</code> declares commands to handle, events and rejections to react on,
 they should all be processed synchronously for a certain <code>Aggregate</code> instance.
 The events produced in each command handler and event/rejection reactors
 should be applied in the same thread as well. Such a synchronous entity processing allows to
 prevent the concurrent modification of the entity state.

 <p>The delivery strategies of each of the entity repositories are used to reroute and regroup
 the messages sent for dispatching, and then dispatch those to the instances per-shard.


 <h3>Flow</h3>

 <p><img src="./doc-files/sharding-commands-flow.png" alt="Sharding command flow">

 <i>Command flow. Events and Rejections are dispatched similarly.</i>

 <p>In this flow the message channel serves as a single-lane road, enqueuing the messages
 from multiple senders (potentially, posting their messages simultaneously) and transferring
 them to a single window on a receiving side.

 <h3>Transport</h3>

 <p>A <a href="../../../../io/spine/server/delivery/ShardedStream.html" title="class in io.spine.server.delivery">ShardedStream</a> is introduced as
 a convenience wrapper over channels, used to exchange the messages to each of the shards.


 <h3>Configuration</h3>

 <p>By default each repository defines a number of shards equal to <code>1</code>, so all the entities
 of the repository belong to a single shard.

 <p>To define a custom sharding strategy for the entity repository one should override the
 <a href="../../../../io/spine/server/delivery/Shardable.html#getShardingStrategy--"><code>getShardingStrategy()</code></a>.
 One of the possible values to return is a
 <a href="../../../../io/spine/server/delivery/UniformAcrossTargets.html" title="class in io.spine.server.delivery"><code>UniformAcrossTargets</code></a>-produced value:

 <pre>
  <code>
  public static class TripleShardProjectRepository
             extends AggregateRepository&amp;lt;ProjectId, DeliveryProject&amp;gt; {

         public TripleShardProjectRepository() {
             super();
             getRejectionRouting().replaceDefault(routeByProjectId());
         }

         {@literal @}Override
         public ShardingStrategy getShardingStrategy() {
             return UniformAcrossTargets.forNumber(3);
         }
     }
 </code>
 </pre>

 <p>In the example above the entities will be split into three shards by a their
 <code>getId().hashCode() % 3</code> value. While such an approach is hard to call a truly uniform,
 as the nature of identifiers is completely different from domain to domain, it seems to be good
 enough for many typical cases.

 <p>However, it's <b>extremely</b> important to remember that the transport implementation
 means a lot. The provided out-of-the-box in-process implementation is naïve and should be
 replaced with something playing well with the underlying infrastructure.


 <h3>Implementation Details</h3>

 <p>A JVM-wide <a href="../../../../io/spine/server/delivery/Sharding.html" title="interface in io.spine.server.delivery"><code>Sharding</code></a> service is introduced. Its
 implementation is exposed via <a href="../../../../io/spine/server/ServerEnvironment.html" title="class in io.spine.server"><code>ServerEnvironment</code></a> and is
 used to integrate the transport factory, register new shards and define which shards
 are served within the current JVM.

 <p><code>AggregateRepository</code>, <code>ProcessManagerRepository</code> and <code>ProjectionRepository</code>
 become shardable by implementing the <a href="../../../../io/spine/server/delivery/Shardable.html" title="interface in io.spine.server.delivery"><code>Shardable</code></a> interface.

 <p>Each <code>Shardable</code> defines the total number of shards and the way to tell the shard
 by the entity ID.

 <p>Each <code>Shardable</code> defines a number of message consumers, each devoted to consuming
 messages of a certain kind (e.g. <code>Command</code>). A special
 <a href="../../../../io/spine/server/delivery/ShardedStreamConsumer.html" title="interface in io.spine.server.delivery"><code>ShardedStreamConsumer</code></a> interface is
 introduced for this matter. The consumers are used to receive the messages, sent to a specific
 shard. To specify the type of messages and the type of the entity to which messages are headed,
 a <a href="../../../../io/spine/server/delivery/DeliveryTag.html" title="class in io.spine.server.delivery"><code>DeliveryTag</code></a> must be defined for the each consumer.

 <p>The <code>Delivery</code> is split into <a href="../../../../io/spine/server/delivery/Sender.html" title="class in io.spine.server.delivery">sending</a> and
 <a href="../../../../io/spine/server/delivery/Consumer.html" title="class in io.spine.server.delivery">consuming</a> parts, each communicating with
 the transport layer. The consuming part of a <code>Delivery</code> is a <code>ShardedStreamConsumer</code>
 implementation.

 <p>An internal <code>ShardingRegistry</code> is used
 to hold all the known consumers and their streams.  Its instance belongs to the <code>Sharding</code>
 service and is JVM-wide as well.</div>
</div>
<!-- ======= START OF BOTTOM NAVBAR ====== -->
<div class="bottomNav"><a name="navbar.bottom">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.bottom" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.bottom.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../overview-summary.html">Overview</a></li>
<li class="navBarCell1Rev">Package</li>
<li>Class</li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../index-all.html">Index</a></li>
<li><a href="../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../io/spine/server/commandbus/package-summary.html">Prev&nbsp;Package</a></li>
<li><a href="../../../../io/spine/server/entity/package-summary.html">Next&nbsp;Package</a></li>
</ul>
<ul class="navList">
<li><a href="../../../../index.html?io/spine/server/delivery/package-summary.html" target="_top">Frames</a></li>
<li><a href="package-summary.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_bottom">
<li><a href="../../../../allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_bottom");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<a name="skip.navbar.bottom">
<!--   -->
</a></div>
<!-- ======== END OF BOTTOM NAVBAR ======= -->
</body>
</html>
